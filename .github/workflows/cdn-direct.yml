- name: Find or create CloudFront distribution
        id: dist
        shell: bash
        run: |
          set -e
          ORIGIN_DOMAIN="${WEB_BUCKET}.s3.${AWS_REGION}.amazonaws.com"
          COMMENT="HUNTECH Web CDN for ${WEB_BUCKET}"

          # Try to find an existing distribution that already uses this origin domain and our comment
          DIST_ID=$(aws cloudfront list-distributions \
            --query "DistributionList.Items[?contains(Origins.Items[].DomainName, '${ORIGIN_DOMAIN}') && Comment=='${COMMENT}'].Id | [0]" \
            --output text 2>/dev/null || true)

          if [ -z "$DIST_ID" ] || [ "$DIST_ID" = "None" ]; then
            echo "Creating distribution..."
            CALLER_REF="huntech-$(date +%s)"

            # Build a distribution config for OAC: keep S3OriginConfig, set OriginAccessIdentity to an empty string,
            # and attach OriginAccessControlId to the origin. Omit 'CachedMethods' (API doesn't accept it here).
            DIST_CFG=$(jq -n \
              --arg ref "$CALLER_REF" \
              --arg comment "$COMMENT" \
              --arg origin "$ORIGIN_DOMAIN" \
              --arg oac "$OAC_ID" \
              '{
                CallerReference: $ref,
                Comment: $comment,
                Enabled: true,
                Origins: {
                  Quantity: 1,
                  Items: [{
                    Id: "S3Origin",
                    DomainName: $origin,
                    S3OriginConfig: { OriginAccessIdentity: "" },
                    OriginAccessControlId: $oac
                  }]
                },
                DefaultCacheBehavior: {
                  TargetOriginId: "S3Origin",
                  ViewerProtocolPolicy: "redirect-to-https",
                  AllowedMethods: { Quantity: 2, Items: ["GET","HEAD"] },
                  Compress: true,
                  CachePolicyId: "658327ea-f89d-4fab-a63d-7e88639e58f6"
                },
                DefaultRootObject: "index.html",
                PriceClass: "PriceClass_100",
                HttpVersion: "http2"
              }')

            DIST_ID=$(aws cloudfront create-distribution \
              --distribution-config "$DIST_CFG" \
              --query "Distribution.Id" --output text)
            echo "Created distribution: $DIST_ID"
          else
            echo "Using distribution: $DIST_ID"
          fi

          echo "DIST_ID=$DIST_ID" >> $GITHUB_ENV
