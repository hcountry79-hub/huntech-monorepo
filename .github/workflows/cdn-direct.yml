name: HUNTECH CDN (Direct API — create OAC + Distribution + lock bucket)

on:
  workflow_dispatch:

jobs:
  cdn_direct:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    env:
      AWS_REGION: us-east-1
      ACCOUNT_ID: 382773571217
      ROLE_TO_ASSUME: arn:aws:iam::382773571217:role/HUNTECH-CICD
      WEB_BUCKET: huntech-web-382773571217-us-east-1-core

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      # Minimal, focused permissions for this run
      - name: Ensure CloudFront/S3 read perms (inline)
        shell: bash
        run: |
          cat > /tmp/HUNTECH-CDN-Direct.json <<'JSON'
          {
            "Version": "2012-10-17",
            "Statement": [
              {
                "Sid": "CloudFrontManage",
                "Effect": "Allow",
                "Action": [
                  "cloudfront:CreateDistribution",
                  "cloudfront:UpdateDistribution",
                  "cloudfront:GetDistribution",
                  "cloudfront:GetDistributionConfig",
                  "cloudfront:ListDistributions",
                  "cloudfront:CreateInvalidation",
                  "cloudfront:CreateOriginAccessControl",
                  "cloudfront:ListOriginAccessControls",
                  "cloudfront:GetOriginAccessControl"
                ],
                "Resource": "*"
              },
              {
                "Sid": "S3Policy",
                "Effect": "Allow",
                "Action": [
                  "s3:GetBucketPolicy",
                  "s3:PutBucketPolicy",
                  "s3:PutObject",
                  "s3:DeleteObject",
                  "s3:GetObject"
                ],
                "Resource": [
                  "arn:aws:s3:::${WEB_BUCKET}",
                  "arn:aws:s3:::${WEB_BUCKET}/*"
                ]
              }
            ]
          }
          JSON
          aws iam put-role-policy \
            --role-name HUNTECH-CICD \
            --policy-name HUNTECH-CDN-Direct \
            --policy-document file:///tmp/HUNTECH-CDN-Direct.json

      - name: Resolve or create OAC (sigv4, always sign)
        id: oac
        shell: bash
        run: |
          set -e
          NAME="oac-${WEB_BUCKET}"
          # Try to find an existing OAC by name
          OAC_ID=$(aws cloudfront list-origin-access-controls \
            --query "OriginAccessControlList.Items[?Name=='${NAME}'].Id" --output text 2>/dev/null || true)
          if [ -z "$OAC_ID" ] || [ "$OAC_ID" = "None" ]; then
            # Create OAC
            CFG=$(cat <<EOF
            {
              "Name": "${NAME}",
              "Description": "OAC for ${WEB_BUCKET}",
              "SigningProtocol": "sigv4",
              "SigningBehavior": "always",
              "OriginAccessControlOriginType": "s3"
            }
            EOF
            )
            OAC_ID=$(aws cloudfront create-origin-access-control \
              --origin-access-control-config "$CFG" \
              --query "OriginAccessControl.Id" --output text)
            echo "Created OAC: $OAC_ID"
          else
            echo "Using existing OAC: $OAC_ID"
          fi
          echo "OAC_ID=$OAC_ID" >> $GITHUB_ENV

      - name: Find or create CloudFront distribution
        id: dist
        shell: bash
        run: |
          set -e
          ORIGIN_DOMAIN="${WEB_BUCKET}.s3.${AWS_REGION}.amazonaws.com"
          COMMENT="HUNTECH Web CDN for ${WEB_BUCKET}"

          # Try to find an existing dist referencing this origin domain
          DIST_ID=$(aws cloudfront list-distributions \
            --query "DistributionList.Items[?contains(Origins.Items[].DomainName, '${ORIGIN_DOMAIN}') && Comment=='${COMMENT}'].Id | [0]" \
            --output text 2>/dev/null || true)

          if [ -z "$DIST_ID" ] || [ "$DIST_ID" = "None" ]; then
            echo "Creating distribution..."
            CALLER_REF="huntech-$(date +%s)"
            DIST_CFG=$(cat <<EOF
            {
              "CallerReference": "${CALLER_REF}",
              "Comment": "${COMMENT}",
              "Enabled": true,
              "Origins": {
                "Quantity": 1,
                "Items": [{
                  "Id": "S3Origin",
                  "DomainName": "${ORIGIN_DOMAIN}",
                  "S3OriginConfig": {},
                  "OriginAccessControlId": "${OAC_ID}"
                }]
              },
              "DefaultCacheBehavior": {
                "TargetOriginId": "S3Origin",
                "ViewerProtocolPolicy": "redirect-to-https",
                "AllowedMethods": {"Quantity": 2, "Items": ["GET","HEAD"]},
                "CachedMethods": {"Quantity": 2, "Items": ["GET","HEAD"]},
                "Compress": true,
                "CachePolicyId": "658327ea-f89d-4fab-a63d-7e88639e58f6"
              },
              "DefaultRootObject": "index.html",
              "PriceClass": "PriceClass_100",
              "HttpVersion": "http2"
            }
            EOF
            )
            # Create and capture ID
            CREATE_OUT=$(aws cloudfront create-distribution --distribution-config "$DIST_CFG")
            DIST_ID=$(echo "$CREATE_OUT" | jq -r '.Distribution.Id')
            echo "Created distribution: $DIST_ID"
          else
            echo "Using existing distribution: $DIST_ID"
          fi

          echo "DIST_ID=$DIST_ID" >> $GITHUB_ENV

      - name: Wait until distribution is readable and Deployed
        shell: bash
        run: |
          set -e
          for i in {1..90}; do
            set +e
            DNS=$(aws cloudfront get-distribution --id "${DIST_ID}" --query "Distribution.DomainName" --output text 2>/dev/null)
            STATUS=$(aws cloudfront get-distribution --id "${DIST_ID}" --query "Distribution.Status" --output text 2>/dev/null)
            RC=$?
            set -e
            if [ "$RC" -eq 0 ] && [ -n "$DNS" ] && [ "$DNS" != "None" ]; then
              echo "Distribution: $DNS  Status: $STATUS"
              if [ "$STATUS" = "Deployed" ]; then
                echo "DIST_DNS=$DNS" >> $GITHUB_ENV
                break
              fi
            else
              echo "Waiting for distribution to become visible... ($i/90)"
            fi
            sleep 7
          done
          if [ -z "${DIST_DNS:-}" ]; then
            echo "Distribution not Deployed in time"; exit 1
          fi

      - name: Apply bucket policy (allow ONLY this distribution via OAC)
        shell: bash
        run: |
          set -e
          POLICY=$(cat <<EOF
          {
            "Version": "2012-10-17",
            "Statement": [
              {
                "Sid": "AllowCloudFrontServicePrincipalReadOnly",
                "Effect": "Allow",
                "Principal": { "Service": "cloudfront.amazonaws.com" },
                "Action": "s3:GetObject",
                "Resource": "arn:aws:s3:::${WEB_BUCKET}/*",
                "Condition": {
                  "StringEquals": {
                    "AWS:SourceArn": "arn:aws:cloudfront::${ACCOUNT_ID}:distribution/${DIST_ID}"
                  }
                }
              }
            ]
          }
          EOF
          )
          aws s3api put-bucket-policy --bucket "${WEB_BUCKET}" --policy "$POLICY"

      - name: Upload sample index.html
        shell: bash
        run: |
          set -e
          mkdir -p site
          cat > site/index.html <<'HTML'
          <!doctype html><html lang="en"><head>
            <meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
            <title>HUNTΞCH — Core CDN</title>
            <style>
              body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;margin:0;background:#111;color:#fefefe}
              .wrap{max-width:720px;margin:5rem auto;background:#222;padding:2rem;border-radius:12px}
              h1{margin-top:0}
              .tag{display:inline-block;padding:4px 10px;border-radius:999px;background:#3a2e11;color:#ffd34d;font-weight:600;margin-bottom:12px}
            </style>
          </head><body><div class="wrap">
          <div class="tag">HUNTΞCH • CDN</div>
          <h1>Where Innovation Meets Tradition</h1>
          <p>Served privately from S3 via CloudFront (OAC).</p>
          </div></body></html>
          HTML
          aws s3 sync site/ "s3://${WEB_BUCKET}/" --delete --cache-control max-age=60

      - name: Invalidate and probe
        shell: bash
        run: |
          set -e
          aws cloudfront create-invalidation --distribution-id "${DIST_ID}" --paths "/*" >/dev/null
          URL="https://${DIST_DNS}/"
          echo "Visiting: $URL"
          for i in {1..24}; do
            CODE=$(curl -s -o /dev/null -w "%{http_code}" "$URL")
            echo "Attempt $i => $CODE"
            [ "$CODE" = "200" ] && echo "cdn ok: $URL" && exit 0
            sleep 5
          done
          echo "CDN not ready yet"; exit 1

      - name: Done
        run: echo "CDN URL: https://${DIST_DNS}/"
