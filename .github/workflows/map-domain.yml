name: HUNTECH Map Domain (ID or Domain)

on:
  workflow_dispatch:
    inputs:
      dist_input:
        description: "CloudFront Distribution ID (E...) OR Domain (dxxxxx.cloudfront.net)"
        required: true
        default: ""

jobs:
  map_domain:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    env:
      AWS_REGION: us-east-1
      ROLE_TO_ASSUME: arn:aws:iam::382773571217:role/HUNTECH-CICD

      CORE_FQDN: core.huntechusa.com
      APEX_DOMAIN: huntechusa.com
      CLOUDFRONT_ZONE_ID: Z2FDTNDATAQYW2   # Route 53 alias zone for CloudFront (global)

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install jq & dig
        run: |
          set -e
          if ! command -v jq >/dev/null 2>&1; then
            sudo apt-get update -y && sudo apt-get install -y jq
          fi
          if ! command -v dig >/dev/null 2>&1; then
            sudo apt-get update -y && sudo apt-get install -y dnsutils
          fi

      - name: Resolve Hosted Zone (authoritative check)
        id: hz
        run: |
          set -e
          HZ_ID=$(aws route53 list-hosted-zones-by-name --dns-name "${APEX_DOMAIN}" \
            --query "HostedZones[?Name=='${APEX_DOMAIN}.'].Id" --output text | sed 's#/hostedzone/##')
          if [ -z "$HZ_ID" ] || [ "$HZ_ID" = "None" ]; then
            echo "ERROR: Route 53 hosted zone for ${APEX_DOMAIN} not found."; exit 1
          fi
          echo "HZ_ID=$HZ_ID" >> $GITHUB_ENV

          # Soft validation: R53 NS must match public NS for DNS validation to work
          R53_NS=$(aws route53 get-hosted-zone --id "$HZ_ID" --query 'DelegationSet.NameServers' --output text | tr '\t' '\n' | sort)
          PUB_NS=$(dig NS "${APEX_DOMAIN}" +short | sort || true)
          echo "Route53 NS:"; echo "$R53_NS"
          echo "Public  NS:"; echo "$PUB_NS"
          DIFF=$(comm -3 <(echo "$R53_NS") <(echo "$PUB_NS") || true)
          if [ -n "$PUB_NS" ] && [ -n "$DIFF" ]; then
            echo "WARNING: Route 53 may not be authoritative for ${APEX_DOMAIN}. If validation stalls, update registrar NS."
          fi

      - name: Resolve Distribution (accepts ID or domain)
        id: dist
        env:
          DIST_INPUT: ${{ github.event.inputs.dist_input }}
        run: |
          set -e
          if [ -z "${DIST_INPUT}" ]; then
            echo "ERROR: dist_input is required"; exit 1
          fi

          # If it looks like a domain (contains .cloudfront.net), resolve to ID
          if echo "${DIST_INPUT}" | grep -qiE '\.cloudfront\.net$'; then
            DIST_ID=$(aws cloudfront list-distributions \
              --query "DistributionList.Items[?DomainName=='${DIST_INPUT}'].Id | [0]" \
              --output text 2>/dev/null || true)
            if [ -z "$DIST_ID" ] || [ "$DIST_ID" = "None" ]; then
              echo "ERROR: Could not resolve distribution ID from domain ${DIST_INPUT}"; exit 1
            fi
          else
            DIST_ID="${DIST_INPUT}"
          fi

          # Fetch the domain name for this distribution
          DIST_DNS=$(aws cloudfront get-distribution --id "${DIST_ID}" \
            --query "Distribution.DomainName" --output text 2>/dev/null || true)
          if [ -z "$DIST_DNS" ] || [ "$DIST_DNS" = "None" ]; then
            echo "ERROR: Could not read CloudFront distribution ${DIST_ID}"; exit 1
          fi

          echo "DIST_ID=${DIST_ID}"  >> $GITHUB_ENV
          echo "DIST_DNS=${DIST_DNS}" >> $GITHUB_ENV
          echo "Using Distribution: ${DIST_ID}  Domain: ${DIST_DNS}"

      - name: Request ACM certificate in us-east-1 (required by CloudFront)
        id: acm_request
        run: |
          set -e
          CERT_ARN=$(aws acm request-certificate \
            --region us-east-1 \
            --domain-name "${CORE_FQDN}" \
            --validation-method DNS \
            --query CertificateArn --output text)
          echo "CERT_ARN=$CERT_ARN" >> $GITHUB_ENV
          echo "Requested certificate: $CERT_ARN"

      - name: Wait for ACM to return DNS CNAME (robust)
        id: acm_rr
        run: |
          set -e
          RR_NAME=""; RR_TYPE=""; RR_VALUE=""
          for i in $(seq 1 120); do
            REC=$(aws acm describe-certificate --region us-east-1 --certificate-arn "${CERT_ARN}" \
              --query "Certificate.DomainValidationOptions" --output json)
            RR_NAME=$(echo "$REC" | jq -r --arg d "${CORE_FQDN}" '
              (.[]
               | select(.DomainName==$d or .ValidationStatus=="PENDING_VALIDATION")
               | .ResourceRecord.Name) // empty')
            RR_TYPE=$(echo "$REC" | jq -r --arg d "${CORE_FQDN}" '
              (.[]
               | select(.DomainName==$d or .ValidationStatus=="PENDING_VALIDATION")
               | .ResourceRecord.Type) // empty')
            RR_VALUE=$(echo "$REC" | jq -r --arg d "${CORE_FQDN}" '
              (.[]
               | select(.DomainName==$d or .ValidationStatus=="PENDING_VALIDATION")
               | .ResourceRecord.Value) // empty')
            if [ -n "$RR_NAME" ] && [ "$RR_NAME" != "null" ]; then
              echo "ACM returned validation CNAME: $RR_NAME"
              break
            fi
            echo "Waiting for ACM ResourceRecord... ($i/120)"
            sleep 5
          done
          if [ -z "$RR_NAME" ]; then
            echo "ERROR: Validation record not found after waiting. Re-run shortly."; exit 1
          fi
          echo "RR_NAME=$RR_NAME"   >> $GITHUB_ENV
          echo "RR_TYPE=$RR_TYPE"   >> $GITHUB_ENV
          echo "RR_VALUE=$RR_VALUE" >> $GITHUB_ENV

      - name: Upsert DNS validation CNAME in Route 53
        run: |
          set -e
          CHG=$(jq -n --arg n "$RR_NAME" --arg t "$RR_TYPE" --arg v "$RR_VALUE" \
            '{Comment:"ACM DNS validation",Changes:[{Action:"UPSERT",ResourceRecordSet:{Name:$n,Type:$t,TTL:60,ResourceRecords:[{Value:$v}]}}]}')
          aws route53 change-resource-record-sets --hosted-zone-id "${HZ_ID}" --change-batch "$CHG" >/dev/null
          echo "Validation CNAME upserted: $RR_NAME -> $RR_VALUE"

      - name: Wait for certificate to be ISSUED
        run: |
          set -e
          for i in $(seq 1 120); do
            STATUS=$(aws acm describe-certificate --region us-east-1 --certificate-arn "${CERT_ARN}" \
              --query "Certificate.Status" --output text)
            echo "ACM cert status: $STATUS"
            [ "$STATUS" = "ISSUED" ] && exit 0
            sleep 10
          done
          echo "ERROR: Certificate not ISSUED in time"; exit 1

      - name: Attach alias + certificate to CloudFront
        run: |
          set -e
          CFG=$(aws cloudfront get-distribution-config --id "${DIST_ID}")
          ETAG=$(echo "$CFG" | jq -r .ETag)
          DC=$(echo "$CFG" | jq -r '.DistributionConfig')
          NEW=$(echo "$DC" | jq --arg dom "${CORE_FQDN}" --arg arn "${CERT_ARN}" '
            .Aliases.Items = ((.Aliases.Items // []) + [$dom] | unique) |
            .Aliases.Quantity = (.Aliases.Items | length) |
            .ViewerCertificate = {
              "ACMCertificateArn": $arn,
              "SSLSupportMethod": "sni-only",
              "MinimumProtocolVersion": "TLSv1.2_2021"
            }')
          printf '%s' "$NEW" > /tmp/cf.json
          aws cloudfront update-distribution \
            --id "${DIST_ID}" --if-match "${ETAG}" \
            --distribution-config file:///tmp/cf.json >/dev/null
          echo "CloudFront distribution updated with alias + cert"

      - name: Create Route53 A/AAAA ALIAS → CloudFront
        run: |
          set -e
          CHG=$(jq -n --arg fqdn "$CORE_FQDN" --arg z "$CLOUDFRONT_ZONE_ID" --arg target "$DIST_DNS" \
            '{Comment:"Map domain to CloudFront",
              Changes:[
                {Action:"UPSERT",ResourceRecordSet:{Name:$fqdn,Type:"A",AliasTarget:{HostedZoneId:$z,DNSName:$target,EvaluateTargetHealth:false}}},
                {Action:"UPSERT",ResourceRecordSet:{Name:$fqdn,Type:"AAAA",AliasTarget:{HostedZoneId:$z,DNSName:$target,EvaluateTargetHealth:false}}}
              ]}')
          aws route53 change-resource-record-sets --hosted-zone-id "${HZ_ID}" --change-batch "$CHG" >/dev/null
          echo "Alias A/AAAA created: ${CORE_FQDN} → ${DIST_DNS}"

      - name: Invalidate and probe site
        run: |
          set -e
          aws cloudfront create-invalidation --distribution-id "${DIST_ID}" --paths "/*" >/dev/null
          URL="https://${CORE_FQDN}/"
          echo "Visiting: $URL"
          for i in $(seq 1 48); do
            CODE=$(curl -s -o /dev/null -w "%{http_code}" "$URL")
            echo "Attempt $i -> HTTP $CODE"
            [ "$CODE" = "200" ] && { echo "domain ok: $URL"; exit 0; }
            sleep 5
          done
          echo "Site not reachable yet"; exit 1
