name: HUNTECH Verify & Heal (nightly + manual)

on:
  schedule:
    - cron: "22 3 * * *"   # nightly ~3:22 AM UTC; adjust if you want
  workflow_dispatch:

jobs:
  verify_heal:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    env:
      AWS_REGION: us-east-1
      ROLE_TO_ASSUME: arn:aws:iam::382773571217:role/HUNTECH-CICD
      WEB_BUCKET: huntech-web-382773571217-us-east-1-core
      SITE_FQDN: core.huntechusa.com
      CF_FALLBACK: d2stduzbo1av87.cloudfront.net
      ACCOUNT_ID: "382773571217"

    steps:
      - uses: actions/checkout@v4
      - uses: aws-actions/configure-aws-credentials@v4
        with: { role-to-assume: ${{ env.ROLE_TO_ASSUME }}, aws-region: ${{ env.AWS_REGION }} }
      - run: sudo apt-get update -y && sudo apt-get install -y jq dnsutils curl

      - name: Discover CloudFront
        run: |
          set -e
          CF_DOMAIN="$(dig +short CNAME ${SITE_FQDN} | sed 's/\.$//' || true)"
          if [ -z "$CF_DOMAIN" ]; then CF_DOMAIN="${CF_FALLBACK}"; fi
          DIST_ID=$(aws cloudfront list-distributions \
            --query "DistributionList.Items[?DomainName=='${CF_DOMAIN}'].Id | [0]" \
            --output text 2>/dev/null || true)
          if [ -z "$DIST_ID" ] || [ "$DIST_ID" = "None" ]; then
            echo "ERROR: Cannot resolve distribution ID"; exit 1
          fi
          echo "DIST_ID=$DIST_ID" >> $GITHUB_ENV
          echo "DIST_DOMAIN=$CF_DOMAIN" >> $GITHUB_ENV

      - name: Verify default root + index presence + policy
        id: check
        run: |
          set -e
          CFG=$(aws cloudfront get-distribution-config --id "${DIST_ID}")
          DC=$(echo "$CFG" | jq -r '.DistributionConfig')
          ROOT=$(echo "$DC" | jq -r '.DefaultRootObject // empty')
          echo "ROOT=${ROOT}" >> $GITHUB_ENV

          if aws s3api head-object --bucket "${WEB_BUCKET}" --key "index.html" >/dev/null 2>&1; then
            echo "INDEX_OK=true" >> $GITHUB_ENV
          else
            echo "INDEX_OK=false" >> $GITHUB_ENV
          fi

          POL=$(aws s3api get-bucket-policy --bucket "${WEB_BUCKET}" --query 'Policy' --output text 2>/dev/null || echo "")
          echo "$POL" > /tmp/policy.json || true
          MATCH=$(jq -r --arg acct "${ACCOUNT_ID}" --arg did "${DIST_ID}" \
            'try (.Statement[] | select(.Principal.Service=="cloudfront.amazonaws.com")
                | select(.Action=="s3:GetObject")
                | select(.Condition."StringEquals"."AWS:SourceArn"=="arn:aws:cloudfront::"+$acct+":distribution/"+$did)) | .Sid' /tmp/policy.json 2>/dev/null || true)
          if [ -n "$MATCH" ]; then
            echo "POLICY_OK=true" >> $GITHUB_ENV
          else
            echo "POLICY_OK=false" >> $GITHUB_ENV
          fi

      - name: Heal (if needed)
        run: |
          set -e
          DID="${DIST_ID}"
          NEED=false
          # set DefaultRootObject
          if [ "${ROOT}" != "index.html" ]; then
            CFG=$(aws cloudfront get-distribution-config --id "${DID}")
            ETAG=$(echo "$CFG" | jq -r .ETag)
            DC=$(echo "$CFG" | jq -r '.DistributionConfig')
            NEW=$(echo "$DC" | jq '.DefaultRootObject = "index.html"')
            printf '%s' "$NEW" > /tmp/new-cf.json
            aws cloudfront update-distribution --id "${DID}" --if-match "${ETAG}" \
              --distribution-config file:///tmp/new-cf.json >/dev/null
            NEED=true
          fi
          # upload index if missing
          if [ "${INDEX_OK}" != "true" ]; then
            mkdir -p _site
            printf '%s\n' '<!doctype html><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>HUNTΞCH — Core</title><body style="font-family:system-ui;background:#111;color:#fff;padding:3rem"><h1>HUNTΞCH — Core</h1><p>Auto-heal OK.</p></body>' > _site/index.html
            aws s3 sync _site/ "s3://${WEB_BUCKET}/" --delete --cache-control max-age=60
            NEED=true
          fi
          # apply policy if mismatched
          if [ "${POLICY_OK}" != "true" ]; then
            POLICY=$(jq -n --arg bucket "${WEB_BUCKET}" --arg dist "${DID}" --arg acct "${ACCOUNT_ID}" '{
              Version:"2012-10-17",
              Statement:[{
                Sid:"AllowCloudFrontServicePrincipalReadOnly",
                Effect:"Allow",
                Principal:{Service:"cloudfront.amazonaws.com"},
                Action:"s3:GetObject",
                Resource:("arn:aws:s3:::"+$bucket+"/*"),
                Condition:{StringEquals:{"AWS:SourceArn":("arn:aws:cloudfront::"+$acct+":distribution/"+$dist)}}
              }]
            }')
            printf '%s' "$POLICY" > /tmp/policy.json
            aws s3api put-bucket-policy --bucket "${WEB_BUCKET}" --policy file:///tmp/policy.json
            NEED=true
          fi
          if [ "$NEED" = true ]; then
            aws cloudfront create-invalidation --distribution-id "${DID}" --paths "/*" >/dev/null
          fi

      - name: Probe /index.html and /
        run: |
          set -e
          for PATH in "/index.html" "/"; do
            URL="https://${SITE_FQDN}${PATH}"
            for i in $(seq 1 36); do
              CODE=$(curl -s -o /dev/null -w "%{http_code}" "$URL")
              echo "GET $URL -> $CODE (try $i/36)"
              [ "$CODE" = "200" ] && break
              sleep 5
            done
          done
          echo "verify ok: https://${SITE_FQDN}/"
