name: HUNTECH Protect API (Cognito JWT)

on:
  workflow_dispatch:

jobs:
  protect:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    env:
      AWS_REGION: us-east-1
      ACCOUNT_ID: 382773571217
      ROLE_TO_ASSUME: arn:aws:iam::382773571217:role/HUNTECH-CICD
      STACK_NAME: HUNTECH-Foundation-core
      TEMPLATE_PATH: infra/cfn/huntech_core_stack_protected.yaml
      PROJECT_NAME: HUNTECH
      ENV_NAME: core

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Resolve Cognito pool + client
        id: cognito
        shell: bash
        run: |
          set -e
          POOL_ID=$(aws cognito-idp list-user-pools --max-results 60 \
            --query "UserPools[?Name=='HUNTECH-auth-dev'].Id" --output text)
          if [ -z "$POOL_ID" ] || [ "$POOL_ID" = "None" ]; then
            echo "HUNTECH-auth-dev user pool not found in ${AWS_REGION}"; exit 1
          fi
          CLIENT_ID=$(aws cognito-idp list-user-pool-clients --user-pool-id "$POOL_ID" --max-results 60 \
            --query "UserPoolClients[0].ClientId" --output text)
          if [ -z "$CLIENT_ID" ] || [ "$CLIENT_ID" = "None" ]; then
            echo "No app client in pool $POOL_ID; create one and re-run"; exit 1
          fi
          ISSUER="https://cognito-idp.${AWS_REGION}.amazonaws.com/${POOL_ID}"
          echo "COGNITO_ISSUER=$ISSUER" >> $GITHUB_ENV
          echo "COGNITO_AUDIENCE=$CLIENT_ID" >> $GITHUB_ENV
          echo "PoolId=$POOL_ID  ClientId=$CLIENT_ID  Issuer=$ISSUER"

      - name: Write protected CloudFormation template (health open, seed protected)
        shell: bash
        run: |
          mkdir -p infra/cfn
          cat > ${{ env.TEMPLATE_PATH }} <<'YAML'
          AWSTemplateFormatVersion: '2010-09-09'
          Description: HUNTECH Foundation (core, protected) - HTTP API, Lambda, DynamoDB, S3, EventBridge, Secrets

          Parameters:
            ProjectName: { Type: String, Default: HUNTECH }
            Environment: { Type: String, Default: core }
            CreateApiAuthorizer: { Type: String, AllowedValues: ['true','false'], Default: 'true' }
            CognitoIssuer: { Type: String, Default: '' }
            CognitoAudience: { Type: List<String>, Default: [] }

          Conditions:
            UseAuthorizer: !And
              - !Equals [ !Ref CreateApiAuthorizer, 'true' ]
              - !Not [ !Equals [ !Ref CognitoIssuer, '' ] ]

          Resources:
            # (Buckets/Table/Role/Function are already created in core stack; we only need API parts for protection)
            HttpApi:
              Type: AWS::ApiGatewayV2::Api
              Properties: { Name: !Sub '${ProjectName}-${Environment}-HttpApi', ProtocolType: HTTP }

            HttpAuthorizer:
              Type: AWS::ApiGatewayV2::Authorizer
              Condition: UseAuthorizer
              Properties:
                ApiId: !Ref HttpApi
                AuthorizerType: JWT
                IdentitySource: [ '$request.header.Authorization' ]
                Name: CognitoJwt
                JwtConfiguration:
                  Audience: !Ref CognitoAudience
                  Issuer: !Ref CognitoIssuer

            # Integration stays the same logical name so routes wire up
            HttpIntegration:
              Type: AWS::ApiGatewayV2::Integration
              Properties:
                ApiId: !Ref HttpApi
                IntegrationType: AWS_PROXY
