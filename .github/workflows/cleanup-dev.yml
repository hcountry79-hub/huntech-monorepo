name: HUNTECH Cleanup (remove old *-dev stacks)

on:
  workflow_dispatch:

jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    env:
      AWS_REGION: us-east-1
      ACCOUNT_ID: 382773571217
      ROLE_TO_ASSUME: arn:aws:iam::382773571217:role/HUNTECH-CICD
      TARGET_STACKS: "HUNTECH-Foundation-dev HUNTECH-dev"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Remove legacy *-dev stacks (empties buckets first)
        shell: bash
        run: |
          set -euo pipefail

          empty_bucket() {
            local B="$1"
            [ -z "$B" ] && return 0
            echo "==> Emptying bucket: $B"
            # Delete all object versions + delete markers (handles versioned buckets)
            while true; do
              VERS_JSON=$(aws s3api list-object-versions --bucket "$B" --max-items 1000 --output json || echo '{}')
              KEYS=$(echo "$VERS_JSON" | jq -r '
                [
                  (.Versions // [])[] | {Key:.Key, VersionId:.VersionId}
                ] + [
                  (.DeleteMarkers // [])[] | {Key:.Key, VersionId:.VersionId}
                ] ')
              COUNT=$(echo "$KEYS" | jq -r 'length')
              if [ "$COUNT" -eq 0 ]; then
                break
              fi
              PAYLOAD=$(echo "$KEYS" | jq -c '{Objects: ., Quiet: false}')
              aws s3api delete-objects --bucket "$B" --delete "$PAYLOAD" >/dev/null || true
            done
            # Also remove any remaining current objects (for non-versioned)
            aws s3 rm "s3://$B" --recursive >/dev/null 2>&1 || true
            echo "==> Emptied: $B"
          }

          delete_stack_if_exists() {
            local STACK="$1"
            echo ""
            echo "===== STACK: $STACK ====="
            if ! aws cloudformation describe-stacks --stack-name "$STACK" >/dev/null 2>&1; then
              echo "No such stack (skipping): $STACK"
              return 0
            fi

            # Find S3 buckets created by this stack
            BUCKETS=$(aws cloudformation list-stack-resources --stack-name "$STACK" \
              --query "StackResourceSummaries[?ResourceType=='AWS::S3::Bucket'].PhysicalResourceId" \
              --output text || true)

            for B in $BUCKETS; do
              empty_bucket "$B"
            done

            echo "Deleting stack: $STACK"
            aws cloudformation delete-stack --stack-name "$STACK"
            echo "Waiting for DELETE_COMPLETE..."
            aws cloudformation wait stack-delete-complete --stack-name "$STACK" || {
              echo "WARN: wait failed; stack may have finished or been partially removed"
            }
            echo "Deleted: $STACK"
          }

          # Require jq
          if ! command -v jq >/dev/null 2>&1; then
            echo "jq not found. Installing..."
            sudo apt-get update -y >/dev/null && sudo apt-get install -y jq >/dev/null
          fi

          for S in $TARGET_STACKS; do
            delete_stack_if_exists "$S"
          done

          echo ""
          echo "Cleanup complete."
