name: HUNTECH Icon Autodeploy (generate → S3 → CF invalidate → probe)

on:
  workflow_dispatch:
    inputs:
      style:
        description: "icon style: wordmark-gold | wordmark-white | star-gold | star-white | monogram-gold | monogram-white"
        required: false
        default: "wordmark-gold"

jobs:
  icon:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    env:
      AWS_REGION: us-east-1
      ROLE_TO_ASSUME: arn:aws:iam::382773571217:role/HUNTECH-CICD
      WEB_BUCKET: huntech-web-382773571217-us-east-1-core
      SITE_FQDN: core.huntechusa.com
      GOLD: "#FFD34D"     # heritage gold
      BLACK: "#0B0B0B"    # deep black
      WHITE: "#FFFFFF"

    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install ImageMagick + tools
        run: |
          sudo apt-get update -y
          sudo apt-get install -y imagemagick jq curl

      - name: Generate icons (1024 base → 512/192/180)
        env:
          STYLE: ${{ github.event.inputs.style }}
        run: |
          set -e
          mkdir -p icons

          color_fill() {
            case "$1" in
              *gold*) echo "${GOLD}";;
              *white*) echo "${WHITE}";;
              *) echo "${GOLD}";;
            esac
          }

          draw_wordmark() {
            local fill="$1"
            convert -size 1024x1024 xc:${BLACK} \
              -gravity center \
              -fill "$fill" -pointsize 210 \
              -font DejaVu-Sans \
              -annotate +0+0 "HUNTΞCH" \
              icons/1024.png
          }

          draw_star() {
            local fill="$1"
            # Base star: long N–S, shorter E–W, subtle diagonals
            convert -size 1024x1024 xc:${BLACK} \
              -stroke none -fill "$fill" \
              -draw "rectangle 507,140 517,884" \
              -draw "rectangle 140,507 884,517" \
              -fill "$fill" -draw "polygon 512,180 532,512 512,844 492,512" \
              -fill "$fill" -draw "polygon 180,512 512,532 844,512 512,492" \
              icons/1024.png
          }

          draw_monogram() {
            local fill="$1"
            convert -size 1024x1024 xc:${BLACK} \
              -gravity center \
              -fill "$fill" -pointsize 360 -font DejaVu-Sans \
              -annotate +0-50 "HΞ" \
              -fill "$fill" -stroke none \
              -draw "rectangle 507,650 517,910" \
              icons/1024.png
          }

          case "$STYLE" in
            wordmark-gold)  draw_wordmark "${GOLD}" ;;
            wordmark-white) draw_wordmark "${WHITE}" ;;
            star-gold)      draw_star "${GOLD}" ;;
            star-white)     draw_star "${WHITE}" ;;
            monogram-gold)  draw_monogram "${GOLD}" ;;
            monogram-white) draw_monogram "${WHITE}" ;;
            *)              draw_wordmark "${GOLD}" ;;
          esac

          # Derivatives
          convert icons/1024.png -resize 512x512 icons/512.png
          convert icons/1024.png -resize 192x192 icons/192.png
          convert icons/1024.png -resize 180x180 icons/apple-touch-icon.png

      - name: Upload icons to S3 and update manifest/meta
        run: |
          set -e
          # Upload
          aws s3 cp icons/512.png "s3://${WEB_BUCKET}/icons/512.png" --cache-control max-age=86400
          aws s3 cp icons/192.png "s3://${WEB_BUCKET}/icons/192.png" --cache-control max-age=86400
          aws s3 cp icons/apple-touch-icon.png "s3://${WEB_BUCKET}/apple-touch-icon.png" --cache-control max-age=86400

          # Ensure manifest references 192/512 icons
          aws s3 cp "s3://${WEB_BUCKET}/manifest.json" manifest.json || echo '{}' > manifest.json
          if ! jq -e '.icons' manifest.json >/dev/null 2>&1; then
            echo '{}' > manifest.json
          fi
          jq --argjson icons '[{"src":"/icons/192.png","sizes":"192x192","type":"image/png"},{"src":"/icons/512.png","sizes":"512x512","type":"image/png"}]' \
             '.name="HUNTΞCH" | .short_name="HUNTΞCH" | .display="standalone" | .start_url="/index.html" | .background_color="#111111" | .theme_color="#111111" | .icons=$icons' \
             manifest.json > manifest.new.json
          aws s3 cp manifest.new.json "s3://${WEB_BUCKET}/manifest.json" --cache-control max-age=300

          # Inject <link rel="apple-touch-icon"> if missing
          aws s3 cp "s3://${WEB_BUCKET}/index.html" index.html
          if ! grep -qi 'apple-touch-icon' index.html; then
            sed -i 's#<head>#<head><link rel="apple-touch-icon" href="/apple-touch-icon.png">#' index.html
            aws s3 cp index.html "s3://${WEB_BUCKET}/index.html" --cache-control max-age=300
          fi

      - name: Invalidate CloudFront
        run: |
          set -e
          # Find distribution by CNAME or origin
          CF_DOMAIN=$(dig +short CNAME ${SITE_FQDN} | sed 's/\.$//' || true)
          [ -z "$CF_DOMAIN" ] && CF_DOMAIN=""
          if [ -n "$CF_DOMAIN" ]; then
            DIST_ID=$(aws cloudfront list-distributions --query "DistributionList.Items[?DomainName=='${CF_DOMAIN}'].Id | [0]" --output text 2>/dev/null || true)
          fi
          if [ -z "$DIST_ID" ] || [ "$DIST_ID" = "None" ]; then
            ORIGIN="${WEB_BUCKET}.s3.${AWS_REGION}.amazonaws.com"
            DIST_ID=$(aws cloudfront list-distributions --query "DistributionList.Items[?contains(Origins.Items[].DomainName, '${ORIGIN}')].Id | [0]" --output text 2>/dev/null || true)
          fi
          aws cloudfront create-invalidation --distribution-id "${DIST_ID}" --paths "/*" >/dev/null
          echo "Invalidation created for ${DIST_ID}"

      - name: Probe /
        run: |
          set -e
          URL="https://${SITE_FQDN}/"
          for i in $(seq 1 36); do
            CODE=$(curl -s -o /dev/null -w "%{http_code}" "$URL")
            echo "GET $URL -> $CODE (try $i/36)"
            [ "$CODE" = "200" ] && { echo "icon ok: $URL"; exit 0; }
            sleep 5
          done
          echo "Site not 200 yet; edges still updating."
