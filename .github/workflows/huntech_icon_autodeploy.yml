name: HUNTECH Icon Autodeploy (compass)

on:
  workflow_dispatch:
    inputs:
      style:
        description: "compass-gold | compass-white | wordmark-gold | wordmark-white | star-gold | star-white | monogram-gold | monogram-white"
        required: false
        default: "compass-gold"

jobs:
  icon:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    env:
      AWS_REGION: us-east-1
      ROLE_TO_ASSUME: arn:aws:iam::382773571217:role/HUNTECH-CICD
      WEB_BUCKET: huntech-web-382773571217-us-east-1-core
      SITE_FQDN: core.huntechusa.com

      BLACK: "#0B0B0B"
      GOLD: "#FFD34D"
      WHITE: "#FFFFFF"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install ImageMagick + tools
        run: |
          set -e
          sudo apt-get update -y
          sudo apt-get install -y imagemagick jq dnsutils curl

      - name: Render icon (1024 base → 512/192/180)
        env:
          STYLE: ${{ github.event.inputs.style }}
        run: |
          set -e
          mkdir -p icons

          pick_fill() {
            case "$1" in
              *white*) echo "${WHITE}";;
              *)       echo "${GOLD}";;
            esac
          }

          draw_wordmark() {
            local fill="$1"
            convert -size 1024x1024 xc:${BLACK} \
              -gravity center -fill "$fill" -pointsize 210 -font DejaVu-Sans \
              -annotate +0+0 "HUNTΞCH" icons/1024.png
          }

          draw_star() {
            local fill="$1"
            convert -size 1024x1024 xc:${BLACK} icons/1024.png
            # long N–S, short E–W
            convert icons/1024.png -fill "$fill" -stroke none -draw "rectangle 507,140 517,884" icons/1024.png
            convert icons/1024.png -fill "$fill" -stroke none -draw "rectangle 140,507 884,517" icons/1024.png
            # fine tips
            convert icons/1024.png -fill "$fill" -stroke none \
              -draw "polygon 512,180 532,512 512,844 492,512" \
              -draw "polygon 180,512 512,532 844,512 512,492" icons/1024.png
          }

          draw_monogram() {
            local fill="$1"
            convert -size 1024x1024 xc:${BLACK} -gravity center \
              -fill "$fill" -pointsize 360 -font DejaVu-Sans \
              -annotate +0-50 "HΞ" icons/1024.png
            convert icons/1024.png -fill "$fill" -stroke none \
              -draw "rectangle 507,650 517,910" icons/1024.png
          }

          # VINTAGE COMPASS (subtle north): rings + ticks + north needle + tiny mark
          draw_compass() {
            local fill="$1"
            # base
            convert -size 1024x1024 xc:${BLACK} icons/1024.png
            # outer ring
            convert icons/1024.png -fill none -stroke "$fill" -strokewidth 18 \
              -draw "circle 512,512 512,160" icons/1024.png
            # inner ring
            convert icons/1024.png -fill none -stroke "$fill" -strokewidth 8 \
              -draw "circle 512,512 512,230" icons/1024.png
            # N/E/S/W ticks (N slightly longer)
            convert icons/1024.png -fill "$fill" -stroke "$fill" -strokewidth 8 \
              -draw "line 512,230 512,200" \
              -draw "line 512,824 512,794" \
              -draw "line 794,512 764,512" \
              -draw "line 260,512 230,512" icons/1024.png
            # north needle (subtle)
            convert icons/1024.png -fill "$fill" -stroke none \
              -draw "polygon 512,205 540,512 484,512" icons/1024.png
            # tiny north mark (plus)
            convert icons/1024.png -fill "$fill" -stroke "$fill" -strokewidth 6 \
              -draw "line 512,165 512,185" \
              -draw "line 502,175 522,175" icons/1024.png
          }

          FILL="$(pick_fill "$STYLE")"
          case "$STYLE" in
            compass-gold|compass-white) draw_compass "$FILL" ;;
            wordmark-gold)  draw_wordmark "${GOLD}" ;;
            wordmark-white) draw_wordmark "${WHITE}" ;;
            star-gold)      draw_star "${GOLD}" ;;
            star-white)     draw_star "${WHITE}" ;;
            monogram-gold)  draw_monogram "${GOLD}" ;;
            monogram-white) draw_monogram "${WHITE}" ;;
            *)              draw_compass "${GOLD}" ;;
          esac

          # Derivatives
          convert icons/1024.png -resize 512x512 icons/512.png
          convert icons/1024.png -resize 192x192 icons/192.png
          convert icons/1024.png -resize 180x180 icons/apple-touch-icon.png

      - name: Upload icons + update manifest/meta
        run: |
          set -e
          aws s3 cp icons/512.png "s3://${WEB_BUCKET}/icons/512.png" --cache-control max-age=86400
          aws s3 cp icons/192.png "s3://${WEB_BUCKET}/icons/192.png" --cache-control max-age=86400
          aws s3 cp icons/apple-touch-icon.png "s3://${WEB_BUCKET}/apple-touch-icon.png" --cache-control max-age=86400

          # manifest
          aws s3 cp "s3://${WEB_BUCKET}/manifest.json" manifest.json || echo '{}' > manifest.json
          jq --argjson icons '[{"src":"/icons/192.png","sizes":"192x192","type":"image/png"},{"src":"/icons/512.png","sizes":"512x512","type":"image/png"}]' \
             '.name="HUNTΞCH" | .short_name="HUNTΞCH" | .display="standalone" | .start_url="/index.html" | .background_color="#111111" | .theme_color="#111111" | .icons=$icons' \
             manifest.json > manifest.new.json
          aws s3 cp manifest.new.json "s3://${WEB_BUCKET}/manifest.json" --cache-control max-age=300

          # ensure apple-touch-icon link exists
          aws s3 cp "s3://${WEB_BUCKET}/index.html" index.html
          if ! grep -qi 'apple-touch-icon' index.html; then
            sed -i 's#<head>#<head><link rel="apple-touch-icon" href="/apple-touch-icon.png">#' index.html
            aws s3 cp index.html "s3://${WEB_BUCKET}/index.html" --cache-control max-age=300
          fi

      - name: Invalidate CloudFront + probe
        run: |
