name: HUNTECH OneClick UI

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]
    paths:
      - ".github/workflows/huntech_oneclick_ui.yml"

jobs:
  oneclick_ui:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    env:
      AWS_REGION: us-east-1
      ROLE_TO_ASSUME: arn:aws:iam::382773571217:role/HUNTECH-CICD
      WEB_BUCKET: huntech-web-382773571217-us-east-1-core
      SITE_FQDN: core.huntechusa.com

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Discover API endpoint
        shell: bash
        run: |
          set -e
          EP="$(aws apigatewayv2 get-apis --query "Items[?Name=='huntech-http'].ApiEndpoint | [0]" --output text || true)"
          if [ -z "$EP" ] || [ "$EP" = "None" ]; then
            EP="$(aws apigatewayv2 get-apis --query "Items[0].ApiEndpoint" --output text || true)"
          fi
          if [ -z "$EP" ] || [ "$EP" = "None" ]; then
            echo "::error::No API Gateway v2 endpoint found in ${AWS_REGION}"; exit 1
          fi
          echo "API_ENDPOINT=$EP" >> "$GITHUB_ENV"
          echo "API: $EP"

      - name: Build UI files
        shell: bash
        run: |
          set -e
          mkdir -p _wired/app
          printf '%s\n' '<!doctype html><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><title>HUNTECH MVP</title><body style="margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:#2d2416;color:#ffdf66"><header style="padding:16px 24px;background:#201a10;border-bottom:1px solid #3a2e11;display:flex;justify-content:space-between;align-items:center"><div style="font-weight:800">HUNTECH</div><div style="color:#d9c26d">Where Innovation Meets Tradition</div></header><main style="max-width:1000px;margin:24px auto;padding:0 16px"><section style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px"><div style="background:#201a10;border:1px solid #3a2e11;border-radius:12px;padding:16px"><h2>Shed Hunting</h2><p>Plan grids, mark finds, export KML.</p></div><div style="background:#201a10;border:1px solid #3a2e11;border-radius:12px;padding:16px"><h2>Fly Fishing</h2><p>USGS flows, access points, wade/float.</p></div><div style="background:#201a10;border:1px solid #3a2e11;border-radius:12px;padding:16px"><h2>Whitetail</h2><p>Funnels, 300-yd sits, access routes.</p></div></section><section style="margin-top:18px;background:#201a10;border:1px solid #3a2e11;border-radius:12px;padding:16px"><h3 id="panel-title" style="margin:0 0 8px">Welcome</h3><p id="panel-body" style="margin:0 0 10px">Use the buttons below to hit the live API.</p><div style="display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 10px"><button id="btnPins">GET /pins</button><button id="btnJournal">GET /journal</button><button id="btnPostPin">POST /pins</button><button id="btnPostJournal">POST /journal</button></div><pre id="out" style="background:#17120a;color:#ffdf66;padding:12px;border-radius:8px;min-height:120px;overflow:auto"></pre></section></main><footer style="padding:24px;text-align:center;color:#d9c26d"><small>Â© HUNTECH</small></footer><script src="./app.js"></script></body>' > _wired/app/index.html
          printf '%s\n' '(function(){var API="__API__";var out=document.getElementById("out");function log(t){out.textContent=t;}document.getElementById("btnPins").onclick=function(){getJSON(API+"/pins");};document.getElementById("btnJournal").onclick=function(){getJSON(API+"/journal?userId=demo&journalId=demo");};document.getElementById("btnPostPin").onclick=function(){postJSON(API+"/pins",{userId:"demo",pinId:String(Date.now()),lat:38.15,lon:-90.72,category:"demo"});};document.getElementById("btnPostJournal").onclick=function(){postJSON(API+"/journal",{userId:"demo",journalId:String(Date.now()),note:"Hello from HUNTECH"});};async function getJSON(u){log("GET "+u+" ...");try{var r=await fetch(u);var t=await r.text();log("Status "+r.status+"\\n\\n"+t);}catch(e){log(String(e));}}async function postJSON(u,b){log("POST "+u+" ...");try{var r=await fetch(u,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(b)});var t=await r.text();log("Status "+r.status+"\\n\\n"+t);}catch(e){log(String(e));}}})();' > _wired/app/app.js
          sed -i "s#__API__#${API_ENDPOINT}#g" _wired/app/app.js

      - name: Upload to S3 under /app/
        shell: bash
        run: |
          set -e
          aws s3 sync _wired/ "s3://${WEB_BUCKET}/" --delete --cache-control max-age=30

      - name: Invalidate CloudFront
        shell: bash
        run: |
          set -e
          ORIGIN="${WEB_BUCKET}.s3.${AWS_REGION}.amazonaws.com"
          DIST_ID="$(aws cloudfront list-distributions --query "DistributionList.Items[?contains(Origins.Items[].DomainName, '${ORIGIN}')].Id | [0]" --output text)"
          if [ -z "$DIST_ID" ] || [ "$DIST_ID" = "None" ]; then
            echo "::error::Could not resolve CloudFront distribution for origin ${ORIGIN}"; exit 1
          fi
          aws cloudfront create-invalidation --distribution-id "${DIST_ID}" --paths "/app/*" >/dev/null
          echo "Invalidation created for /app/*"

      - name: Print link
        run: echo "Open: https://${SITE_FQDN}/app/"
