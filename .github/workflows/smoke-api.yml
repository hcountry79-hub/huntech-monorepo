name: HUNTECH Smoke — API & CDN

on:
  workflow_dispatch:
  schedule:
    - cron: "17 5 * * *"   # daily at 05:17 UTC
  push:
    branches: [ "main" ]
    paths:
      - ".github/workflows/smoke-api.yml"

jobs:
  smoke:
    runs-on: ubuntu-latest
    permissions: { id-token: write, contents: read }
    env:
      AWS_REGION: us-east-1
      ROLE_TO_ASSUME: arn:aws:iam::382773571217:role/HUNTECH-CICD
      SITE_FQDN: core.huntechusa.com

    steps:
      - uses: actions/checkout@v4
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Discover API endpoint
        id: api
        shell: bash
        run: |
          set -e
          EP=$(aws apigatewayv2 get-apis --query "Items[?Name=='huntech-http'].ApiEndpoint | [0]" --output text || true)
          if [ -z "$EP" ] || [ "$EP" = "None" ]; then
            EP=$(aws apigatewayv2 get-apis --query "Items[0].ApiEndpoint" --output text || true)
          fi
          if [ -z "$EP" ] || [ "$EP" = "None" ]; then
            echo "::error::No API Gateway v2 endpoint found"; exit 1
          fi
          echo "API_ENDPOINT=$EP" >> $GITHUB_ENV
          echo "API: $EP"

      - name: Probe CDN root (expect 200)
        shell: bash
        run: |
          set -e
          URL="https://${SITE_FQDN}/"
          for i in $(seq 1 12); do
            CODE=$(curl -s -o /dev/null -w "%{http_code}" "$URL")
            echo "GET $URL -> $CODE (try $i/12)"
            [ "$CODE" = "200" ] && exit 0
            sleep 5
          done
          echo "::error::CDN root not 200"; exit 1

      - name: Probe API GET /pins (200/401/403 = pass)
        shell: bash
        run: |
          set -e
          URL="${API_ENDPOINT}/pins"
          CODE=$(curl -s -o /dev/null -w "%{http_code}" "$URL" || echo "000")
          echo "GET $URL -> $CODE"
          case "$CODE" in
            200|401|403) echo "API online ✅";;
            *) echo "::error::Unexpected API status: $CODE"; exit 1;;
          esac
