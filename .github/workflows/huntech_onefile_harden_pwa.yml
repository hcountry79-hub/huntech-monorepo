name: HUNTECH OneFile — Harden CloudFront + Enable PWA + Upload + Probe

on:
  push:
    branches: [ main ]
    paths:
      - ".github/workflows/huntech_onefile_harden_pwa.yml"
  workflow_dispatch:

jobs:
  harden_and_pwa:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    env:
      AWS_REGION: us-east-1
      ROLE_TO_ASSUME: arn:aws:iam::382773571217:role/HUNTECH-CICD
      ACCOUNT_ID: "382773571217"

      # Web & domain
      SITE_FQDN: core.huntechusa.com
      WEB_BUCKET: huntech-web-382773571217-us-east-1-core
      # Fallback CF domain if Site CNAME is not yet visible
      CF_FALLBACK: d2stduzbo1av87.cloudfront.net

      # CloudFront hardening
      LOG_BUCKET: huntech-cf-logs-382773571217-us-east-1
      RHP_NAME: HUNTECH-SecurityHeaders-v1
      WAF_NAME: HUNTECH-Global-WebACL
      WAF_METRIC: huntechGlobalWaf

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install tools
        run: |
          set -e
          sudo apt-get update -y
          sudo apt-get install -y jq dnsutils curl coreutils

      # ---------- Resolve distribution from DNS / fallback / origin ----------
      - name: Resolve CloudFront distribution
        id: dist
        run: |
          set -e
          CF_DOMAIN="$(dig +short CNAME ${SITE_FQDN} | sed 's/\.$//' || true)"
          if [ -z "$CF_DOMAIN" ]; then CF_DOMAIN="${CF_FALLBACK}"; fi

          DIST_ID=$(aws cloudfront list-distributions \
            --query "DistributionList.Items[?DomainName=='${CF_DOMAIN}'].Id | [0]" \
            --output text 2>/dev/null || true)

          if [ -z "$DIST_ID" ] || [ "$DIST_ID" = "None" ]; then
            ORIGIN="${WEB_BUCKET}.s3.${AWS_REGION}.amazonaws.com"
            DIST_ID=$(aws cloudfront list-distributions \
              --query "DistributionList.Items[?contains(Origins.Items[].DomainName, '${ORIGIN}')].Id | [0]" \
              --output text 2>/dev/null || true)
            if [ -n "$DIST_ID" ] && [ "$DIST_ID" != "None" ]; then
              CF_DOMAIN=$(aws cloudfront get-distribution --id "${DIST_ID}" \
                --query "Distribution.DomainName" --output text)
            fi
          fi

          if [ -z "$DIST_ID" ] || [ "$DIST_ID" = "None" ]; then
            echo "ERROR: Could not resolve CloudFront distribution."
            exit 1
          fi

          echo "DIST_ID=$DIST_ID"       >> $GITHUB_ENV
          echo "DIST_DOMAIN=$CF_DOMAIN" >> $GITHUB_ENV
          echo "Using distribution: $DIST_ID ($CF_DOMAIN)"

      # ---------- Ensure S3 log bucket (no LocationConstraint in us-east-1) ----------
      - name: Ensure logs bucket (private, encrypted)
        run: |
          set -e
          if ! aws s3api head-bucket --bucket "${LOG_BUCKET}" 2>/dev/null; then
            echo "Creating logs bucket ${LOG_BUCKET} in us-east-1 (no LocationConstraint)"
            aws s3api create-bucket --bucket "${LOG_BUCKET}"
            aws s3api put-bucket-encryption --bucket "${LOG_BUCKET}" --server-side-encryption-configuration '{"Rules":[{"ApplyServerSideEncryptionByDefault":{"SSEAlgorithm":"AES256"}}]}'
            aws s3api put-public-access-block --bucket "${LOG_BUCKET}" --public-access-block-configuration '{
              "BlockPublicAcls": true, "IgnorePublicAcls": true, "BlockPublicPolicy": true, "RestrictPublicBuckets": true
            }'
            aws s3api put-bucket-ownership-controls --bucket "${LOG_BUCKET}" --ownership-controls '{"Rules":[{"ObjectOwnership":"BucketOwnerEnforced"}]}'
          else
            echo "Logs bucket exists: ${LOG_BUCKET}"
          fi

      # ---------- Ensure Response Headers Policy (security headers) ----------
      - name: Ensure Response Headers Policy
        id: rhp
        run: |
          set -e
          RHP_ID=$(aws cloudfront list-response-headers-policies \
            --query "ResponseHeadersPolicyList.Items[?ResponseHeadersPolicy.ResponseHeadersPolicyConfig.Name=='${RHP_NAME}'].ResponseHeadersPolicy.Id | [0]" \
            --output text 2>/dev/null || true)

          if [ -z "$RHP_ID" ] || [ "$RHP_ID" = "None" ]; then
            cat > rhp.json <<'JSON'
            {
              "ResponseHeadersPolicyConfig": {
                "Name": "HUNTECH-SecurityHeaders-v1",
                "Comment": "Security headers for field test (relaxed CSP)",
                "SecurityHeadersConfig": {
                  "ContentSecurityPolicy": {
                    "Override": true,
                    "ContentSecurityPolicy": "default-src 'self' https: data: blob:; img-src 'self' https: data: blob:; script-src 'self' 'unsafe-inline' https:; style-src 'self' 'unsafe-inline' https:; font-src 'self' https: data:; connect-src 'self' https:; frame-ancestors 'none'; upgrade-insecure-requests"
                  },
                  "StrictTransportSecurity": {
                    "Override": true,
                    "AccessControlMaxAgeSec": 31536000,
                    "IncludeSubdomains": true,
                    "Preload": true
                  },
                  "XContentTypeOptions": { "Override": true },
                  "XFrameOptions": { "Override": true, "FrameOption": "DENY" },
                  "ReferrerPolicy": { "Override": true, "ReferrerPolicy": "strict-origin-when-cross-origin" },
                  "PermissionsPolicy": {
                    "Override": true,
                    "PermissionsPolicy": "geolocation=(), microphone=(), camera=()"
                  }
                }
              }
            }
            JSON
            RHP_ID=$(aws cloudfront create-response-headers-policy \
              --response-headers-policy-config file://rhp.json \
              --query "ResponseHeadersPolicy.Id" --output text)
          fi
          echo "RHP_ID=$RHP_ID" >> $GITHUB_ENV
          echo "Response Headers Policy: $RHP_ID"

      # ---------- Attach headers, enable logs, add custom error pages ----------
      - name: Update distribution (headers + logs + errors + default root)
        run: |
          set -e
          CFG=$(aws cloudfront get-distribution-config --id "${DIST_ID}")
          ETAG=$(echo "$CFG" | jq -r .ETag)
          DC=$(echo "$CFG" | jq -r '.DistributionConfig')

          # Default root -> index.html (idempotent)
          DC=$(echo "$DC" | jq '.DefaultRootObject = "index.html"')

          # Attach response headers policy to default behavior
          DC=$(echo "$DC" | jq --arg rhp "${RHP_ID}" '
            .DefaultCacheBehavior.ResponseHeadersPolicyId = $rhp
          ')

          # Enable standard logging
          DC=$(echo "$DC" | jq --arg b "${LOG_BUCKET}.s3.amazonaws.com" --arg p "cloudfront/" '
            .Logging = { "Enabled": true, "IncludeCookies": false, "Bucket": $b, "Prefix": $p }
          ')

          # SPA-friendly errors (403/404 -> index.html)
          DC=$(echo "$DC" | jq '
            .CustomErrorResponses.Items = ([
              { "ErrorCode": 403, "ResponsePagePath": "/index.html", "ResponseCode": "200", "ErrorCachingMinTTL": 0 },
              { "ErrorCode": 404, "ResponsePagePath": "/index.html", "ResponseCode": "200", "ErrorCachingMinTTL": 0 }
            ]) | .CustomErrorResponses.Quantity = 2
          ')

          printf '%s' "$DC" > /tmp/new-cf.json
          aws cloudfront update-distribution --id "${DIST_ID}" --if-match "${ETAG}" \
            --distribution-config file:///tmp/new-cf.json >/dev/null
          echo "Distribution updated."

      # ---------- Ensure WAF (CloudFront scope in us-east-1) & associate ----------
      - name: Ensure WAFv2 (CloudFront scope) and associate
        run: |
          set -e
          ACL_ARN=$(aws wafv2 list-web-acls --region us-east-1 --scope CLOUDFRONT \
            --query "WebACLs[?Name=='${WAF_NAME}'].ARN | [0]" --output text 2>/dev/null || true)

          if [ -z "$ACL_ARN" ] || [ "$ACL_ARN" = "None" ]; then
            cat > waf.json <<'JSON'
            {
              "Name": "HUNTECH-Global-WebACL",
              "Scope": "CLOUDFRONT",
              "DefaultAction": { "Allow": {} },
              "VisibilityConfig": {
                "SampledRequestsEnabled": true,
                "CloudWatchMetricsEnabled": true,
                "MetricName": "huntechGlobalWaf"
              },
              "Rules": [
                { "Name":"AWSManagedRulesCommonRuleSet","Priority":1,
                  "Statement":{"ManagedRuleGroupStatement":{"VendorName":"AWS","Name":"AWSManagedRulesCommonRuleSet"}},
                  "VisibilityConfig":{"SampledRequestsEnabled":true,"CloudWatchMetricsEnabled":true,"MetricName":"Common"},
                  "OverrideAction":{"None":{}} },
                { "Name":"AWSManagedRulesKnownBadInputsRuleSet","Priority":2,
                  "Statement":{"ManagedRuleGroupStatement":{"VendorName":"AWS","Name":"AWSManagedRulesKnownBadInputsRuleSet"}},
                  "VisibilityConfig":{"SampledRequestsEnabled":true,"CloudWatchMetricsEnabled":true,"MetricName":"BadInputs"},
                  "OverrideAction":{"None":{}} },
                { "Name":"AWSManagedRulesAmazonIpReputationList","Priority":3,
                  "Statement":{"ManagedRuleGroupStatement":{"VendorName":"AWS","Name":"AWSManagedRulesAmazonIpReputationList"}},
                  "VisibilityConfig":{"SampledRequestsEnabled":true,"CloudWatchMetricsEnabled":true,"MetricName":"Reputation"},
                  "OverrideAction":{"None":{}} },
                { "Name":"AWSManagedRulesAnonymousIpList","Priority":4,
                  "Statement":{"ManagedRuleGroupStatement":{"VendorName":"AWS","Name":"AWSManagedRulesAnonymousIpList"}},
                  "VisibilityConfig":{"SampledRequestsEnabled":true,"CloudWatchMetricsEnabled":true,"MetricName":"AnonymousIP"},
                  "OverrideAction":{"None":{}} }
              ]
            }
            JSON
            ACL_ARN=$(aws wafv2 create-web-acl --region us-east-1 --scope CLOUDFRONT \
              --cli-input-json file://waf.json --query "Summary.ARN" --output text)
          fi

          aws wafv2 associate-web-acl --region us-east-1 --scope CLOUDFRONT \
            --web-acl-arn "${ACL_ARN}" \
            --resource-arn "arn:aws:cloudfront::${ACCOUNT_ID}:distribution/${DIST_ID}" >/dev/null || true
          echo "WAF associated."

      # ---------- PWA assets (manifest + service worker + icons + iOS meta) ----------
      - name: Build minimal PWA assets
        run: |
          set -e
          mkdir -p pwa/icons _site

          # Tiny 1x1 PNG (transparent) as placeholder icon (base64)
          ICON_B64="iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mP8/x8AAwMB/ah2PgcAAAAASUVORK5CYII="
          echo "$ICON_B64" | base64 -d > pwa/icons/192.png
          cp pwa/icons/192.png pwa/icons/512.png

          # manifest.json
          cat > pwa/manifest.json <<'JSON'
          {
            "name": "HUNTΞCH",
            "short_name": "HUNTΞCH",
            "start_url": "/index.html",
            "display": "standalone",
            "background_color": "#111111",
            "theme_color": "#111111",
            "icons": [
              { "src": "/icons/192.png", "sizes": "192x192", "type": "image/png" },
              { "src": "/icons/512.png", "sizes": "512x512", "type": "image/png" }
            ]
          }
          JSON

          # service worker
          cat > pwa/sw.js <<'JS'
          self.addEventListener('install', e => {
            self.skipWaiting();
            e.waitUntil(caches.open('huntech-v1').then(c => c.addAll(['/','/index.html','/manifest.json'])));
          });
          self.addEventListener('activate', e => { self.clients.claim(); });
          self.addEventListener('fetch', e => {
            e.respondWith(caches.match(e.request).then(r => r || fetch(e.request)));
          });
          JS

          # pull or create index.html locally
          if aws s3api head-object --bucket "${WEB_BUCKET}" --key "index.html" >/dev/null 2>&1; then
            aws s3 cp "s3://${WEB_BUCKET}/index.html" _site/index.html
          else
            cat > _site/index.html <<'HTML'
            <!doctype html><html lang="en"><head>
            <meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
            <title>HUNTΞCH — Core</title>
            </head><body>
            <div style="font-family:system-ui;-apple-system,Segoe UI,Roboto,sans-serif;padding:3rem;background:#111;color:#fff">
            <h1>HUNTΞCH</h1><p>Field‑test build is live.</p></div>
            </body></html>
