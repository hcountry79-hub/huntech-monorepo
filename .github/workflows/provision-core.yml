name: HUNTECH Provision (Core â€” ONE FILE)

on:
  workflow_dispatch:

jobs:
  provision:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    env:
      AWS_REGION: us-east-1
      ACCOUNT_ID: 382773571217
      ROLE_TO_ASSUME: arn:aws:iam::382773571217:role/HUNTECH-CICD
      STACK_NAME: HUNTECH-Foundation-core
      TEMPLATE_PATH: infra/cfn/huntech_core_stack.yaml

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Write CloudFormation template to workspace (fixed S3 names)
        shell: bash
        run: |
          mkdir -p infra/cfn
          cat > ${{ env.TEMPLATE_PATH }} <<'YAML'
          AWSTemplateFormatVersion: '2010-09-09'
          Description: HUNTECH Foundation (core) - HTTP API, Lambda, DynamoDB, S3 (web/media), EventBridge, Secrets, CloudWatch

          Parameters:
            ProjectName:
              Type: String
              Default: HUNTECH
            Environment:
              Type: String
              Default: core
            CreateApiAuthorizer:
              Type: String
              AllowedValues: ['true','false']
              Default: 'false'
            CognitoUserPoolArn:
              Type: String
              Default: ''
              Description: Provide ARN only if CreateApiAuthorizer=true.

          Conditions:
            UseAuthorizer: !And
              - !Equals [ !Ref CreateApiAuthorizer, 'true' ]
              - !Not [ !Equals [ !Ref CognitoUserPoolArn, '' ] ]

          Resources:
            # S3 buckets: all lowercase, no StackName
            WebBucket:
              Type: AWS::S3::Bucket
              Properties:
                BucketName: !Sub 'huntech-web-${AWS::AccountId}-${AWS::Region}-core'
                PublicAccessBlockConfiguration:
                  BlockPublicAcls: true
                  BlockPublicPolicy: true
                  IgnorePublicAcls: true
                  RestrictPublicBuckets: true
                VersioningConfiguration:
                  Status: Enabled
                BucketEncryption:
                  ServerSideEncryptionConfiguration:
                    - ServerSideEncryptionByDefault:
                        SSEAlgorithm: AES256

            MediaBucket:
              Type: AWS::S3::Bucket
