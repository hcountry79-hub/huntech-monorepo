name: HUNTECH Web — Auto Deploy (API-injected)

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]
    paths:
      - ".github/workflows/web-autodeploy.yml"
      - "**/package.json"
      - "**/pnpm-lock.yaml"
      - "**/yarn.lock"
      - "**/package-lock.json"
      - "**/*.[jt]sx?"
      - "**/*.css"
      - "site/index.html"

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    env:
      AWS_REGION: us-east-1
      ROLE_TO_ASSUME: arn:aws:iam::382773571217:role/HUNTECH-CICD
      WEB_BUCKET: huntech-web-382773571217-us-east-1-core
      SITE_FQDN: core.huntechusa.com
      APP_PATH: "."

    steps:
      - uses: actions/checkout@v4

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install tools
        run: |
          set -e
          sudo apt-get update -y
          sudo apt-get install -y jq dnsutils curl

      # ----- Discover API endpoint directly from API Gateway -----
      - name: Discover API endpoint
        id: api
        shell: bash
        run: |
          set -e
          EP=$(aws apigatewayv2 get-apis --query "Items[?Name=='huntech-http'].ApiEndpoint | [0]" --output text || true)
          if [ -z "$EP" ] || [ "$EP" = "None" ]; then
            EP=$(aws apigatewayv2 get-apis --query "Items[0].ApiEndpoint" --output text || true)
          fi
          if [ -z "$EP" ] || [ "$EP" = "None" ]; then
            echo "::warning::No API detected; proceeding with placeholder UI only"
          else
            echo "API_ENDPOINT=$EP" >> $GITHUB_ENV
            echo "API: $EP"
          fi

      # ----- Inject env for common frontends (Vite/React/Next as SPA) -----
      - name: Write env for build (if API exists)
        if: env.API_ENDPOINT
        working-directory: ${{ env.APP_PATH }}
        shell: bash
        run: |
          set -e
          # Vite
          printf 'VITE_API_URL=%s\n' "${API_ENDPOINT}" > .env.production
          # CRA/React
          printf 'REACT_APP_API_URL=%s\n' "${API_ENDPOINT}" > .env
          echo "Wrote env files for build"

      # ----- Build (auto-detect) -----
      - name: Build frontend (auto-detect)
        working-directory: ${{ env.APP_PATH }}
        shell: bash
        run: |
          set -e
          if [ -f package.json ]; then
            if [ -f pnpm-lock.yaml ] && command -v pnpm >/dev/null 2>&1; then
              pnpm install --frozen-lockfile || pnpm install
              pnpm run build || pnpm build || true
            elif [ -f yarn.lock ] && command -v yarn >/dev/null 2>&1; then
              yarn install --frozen-lockfile || yarn install
              yarn build || true
            else
              npm ci || npm install
              npm run build || true
            fi
          else
            echo "No package.json found; will deploy fallback index.html."
          fi

      - name: Resolve build directory
        id: outdir
        working-directory: ${{ env.APP_PATH }}
        shell: bash
        run: |
          set -e
          OUT=""
          for d in dist build out public; do
            [ -d "$d" ] && OUT="$d" && break
          done
          echo "OUT_DIR=${OUT}" >> $GITHUB_ENV
          if [ -n "$OUT" ]; then echo "Using build output dir: $OUT"; else echo "No build dir found; will deploy fallback index.html."; fi

      - name: Upload site to S3
        working-directory: ${{ env.APP_PATH }}
        shell: bash
        run: |
          set -e
          if [ -n "${OUT_DIR}" ]; then
            aws s3 sync "${OUT_DIR}/" "s3://${WEB_BUCKET}/" --delete --cache-control max-age=60
          else
            mkdir -p _tmp_site
            printf '%s\n' '<!doctype html><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>HUNTΞCH — Core</title><body style="font-family:system-ui;background:#111;color:#fff;padding:3rem"><h1>HUNTΞCH — Core</h1><p>CloudFront + OAC + private S3 is working.</p></body>' > _tmp_site/index.html
            aws s3 sync _tmp_site/ "s3://${WEB_BUCKET}/" --delete --cache-control max-age=60
          fi

      - name: Ensure Default Root = index.html
        shell: bash
        run: |
          set -e
          ORIGIN="${WEB_BUCKET}.s3.${AWS_REGION}.amazonaws.com"
          DIST_ID=$(aws cloudfront list-distributions \
            --query "DistributionList.Items[?contains(Origins.Items[].DomainName, '${ORIGIN}')].Id | [0]" \
            --output text)
          CFG=$(aws cloudfront get-distribution-config --id "${DIST_ID}")
          ETAG=$(echo "$CFG" | jq -r .ETag)
          DC=$(echo "$CFG" | jq -r '.DistributionConfig')
          ROOT=$(echo "$DC" | jq -r '.DefaultRootObject // empty')
          if [ "$ROOT" != "index.html" ]; then
            NEW=$(echo "$DC" | jq '.DefaultRootObject = "index.html"')
            printf '%s' "$NEW" > /tmp/new-cf.json
            aws cloudfront update-distribution --id "${DIST_ID}" --if-match "${ETAG}" \
              --distribution-config file:///tmp/new-cf.json >/dev/null
            echo "Set DefaultRootObject=index.html"
          else
            echo "DefaultRootObject already index.html"
          fi

      - name: Invalidate CloudFront
        shell: bash
        run: |
          set -e
          ORIGIN="${WEB_BUCKET}.s3.${AWS_REGION}.amazonaws.com"
          DIST_ID=$(aws cloudfront list-distributions \
            --query "DistributionList.Items[?contains(Origins.Items[].DomainName, '${ORIGIN}')].Id | [0]" \
            --output text)
          aws cloudfront create-invalidation --distribution-id "${DIST_ID}" --paths "/*" >/dev/null
          echo "Invalidation created"

      - name: Probe CDN (expect 200)
        shell: bash
        run: |
          set -e
          for P in "/index.html" "/"; do
            URL="https://${SITE_FQDN}${P}"
            for i in $(seq 1 48); do
              CODE=$(curl -s -o /dev/null -w "%{http_code}" "$URL")
              echo "GET $URL -> $CODE (try $i/48)"
              [ "$CODE" = "200" ] && break
              sleep 5
            done
          done
          echo "domain ok: https://${SITE_FQDN}/"
